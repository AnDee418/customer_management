# 06. 非機能・セキュリティ・運用（ドラフト）

## 性能/スケーラビリティ
- 一覧/検索はページング・適切なインデックス（顧客ID/外部ID/更新日時、trgm/FTS）
- 同期は Webhook-first（補助的に差分Pull）。外部レート制限に合わせて指数バックオフ
- M2M 参照API SLO: P95 < 200ms、可用性 99.9%（キャッシュ常用なし）
- データ鮮度（Source→DB→API→UI）: P99 ≤ 3秒（合意済み）
- 容量計画（合意案）: 顧客 100k、担当者 300k、発注 1M/年、測定 5M/年、保有5年（アーカイブ併用）

## 可用性/復旧
- 目標: RPO ≤ 15分、RTO ≤ 4時間（要確認）
- コールドバックアップ: 月1回、実機NAS等のコールド領域に取得し、復元手順を整備（復元機能は必須）
- DB: PITR/スナップショット、バックアップの整合性検証と復旧演習（年2回以上）
- 設定/Secrets のバージョン管理とロールバック手順

## セキュリティ（ゼロトラスト前提）
- Supabase RLS による行レベル制御（所有者のみ＋管理者例外、任意でチーム共有）
- M2M/内部API 認証: OAuth2 Client Credentials を採用（短寿命トークン、最小権限、鍵ローテーション）
- 監査閲覧: 管理者アカウントが担当（専用 auditor ロールは導入しない方針）
- 機微情報の最小保持、保存/転送の暗号化、ログのマスキング
- 資格情報/Secrets の分離・ローテーション、最小権限の原則

## ログ/監査/観測性
- 監査対象: create/update/delete/restore/sync/retry/login/permission_change
- メトリクス: 成功率/レイテンシ/再試行/署名失敗/鮮度SLO。ダッシュボード可視化
- アラート: 鮮度SLO逸脱、Websocket切断率、Webhook遅延、M2M 429/5xx 急増

## 品質保証
- 単体/統合/E2E テスト最小セットを維持
- API 契約テストで破壊的変更を検知（フロント/BFF、連携/外部、M2M/利用サービス）
- 変更はレビュー＋自動チェック（Lint/Format/Tests）

## 運用
- リリース: dev→stg→prod。DB マイグレーションは自動化し、PITR 確認
- ヘッダ/キャッシュ: `Cache-Control: no-store` を既定。中間キャッシュ禁止
- 定例レビュー: 監査ログ/失敗ジョブ/権限設定/バックアップ検証結果の点検

## データ保持/廃棄（案）
- 保持: 法令/社内規程に従い最短化。アーカイブは暗号化保管
- 廃棄: 監査ログにトレースを残し、不可逆削除（ソフトデリートは復旧用途）

## 未決事項
- 監視スタック（外部SaaS/プラットフォーム機能）
- 最終合意の RPO/RTO・容量計画の再確認（微調整の可能性）
- 監査ロール `auditor` の導入可否と範囲
