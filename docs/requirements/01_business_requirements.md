# 01. ビジネス要件（ドラフト）

## データ分類/遵法（案）
- 区分: 顧客基本情報（機微度: 高）、連絡先（中〜高）、外部ID（中）
- 法令/規程: 個人情報保護、内部規程に従い最小保持。第三者提供は契約/同意ベース
- 保持: 最短保持＋アーカイブ方針を別紙で定義（未決）。削除は監査可能に

## 目的/背景
- 旧システムがランサムウェア被害で約1か月の復旧を要した反省から、単一障害点と被害範囲（blast radius）を最小化するため、マイクロサービス化を前提とする。
- 本サービス（顧客管理）はマイクロサービス群の中核であり、最も機微性の高い顧客情報を保有するため、強固な権限制御と監査可能性が必須。
- 他サービス（発注、測定、など）と連携し、相互に機能を補完する。
- リアルタイム性を最優先とし、原則キャッシュ常用は行わない（障害時のみ限定的フォールバック）。

## スコープ
### In
- 顧客マスタ（企業・部署・担当者）管理
- 外部システムの発注/測定データID格納、概要情報の参照
- 顧客と外部データの関連付け、検索・フィルタ・閲覧
- 認証/認可（ロールベース＋所有者ベースの行レベル制御）
- 監査ログ（重要操作の記録）
- 他サービス向けの高速M2M参照API（読み取り特化、索引最適化、強整合）

### Out（当面の対象外）
- 顧客ドメインへの他サービスからの直接DBアクセス（API 経由のみ）
- 顧客ドメインへの他サービスからの書き込み（所有サービスである本サービスのみ）
- 見積/請求の金額計算ロジック、複雑な承認ワークフロー

## ステークホルダー
- 営業担当、受注管理担当、技術/検査担当、管理者、情報システム部門、連携先サービス（M2Mクライアント）

## KPI/成功指標（例）
- 顧客検索/詳細到達の操作数・時間の削減
- M2M 参照APIのP95レイテンシ（例: 200ms 以下）、可用性（例: 99.9%）
- Webhook 到着→DB反映→UI通知の鮮度 P99 ≤ 3秒（目標）
- セキュリティインシデントゼロ、監査対応時間の短縮

## 優先度（MoSCoW）
- Must: 顧客管理、外部ID格納、認証/認可、所有者ベースのRLS、監査ログ、基本検索/閲覧、M2M参照API（強整合）、Webhook-first 同期
- Should: エラー通知、手動再同期、タグ/属性付与、検索最適化（インデックス/FTS）
- Could: 画面カスタム、軽量レポート
- Won't (for now): 高度承認、複雑レポート

## リリース計画
- MVP: 顧客CRUD、外部ID格納・参照、基本検索、認証/認可（RLS: 所有者/管理者）、監査、M2M参照API（読み取り、強整合）、Webhook-first 同期
- 以降: 同期ジョブ拡充、通知・再試行UI、権限制御の細分化（チーム/委譲）

## 前提/制約
- アーキテクチャ: マイクロサービス（顧客管理はソース・オブ・トゥルース）。他サービスはAPI経由、顧客データの書き込みは本サービスのみ
- 技術: Next.js（フロント）、Node.js（BFF/M2M参照API）、Python FastAPI（外部連携）、Supabase（DB & Auth）
- デプロイ: Vercel（フロント/BFF）、Render（FastAPI）
- セキュリティ: Supabase RLS/RBAC、最小権限、Secrets 管理、署名付きM2M、監査必須

## リスクと対応（例）
- 外部APIのレート制限/停止 → バックオフ・キュー・差分同期
- データモデル変化 → 互換レイヤ/マイグレーション手順、段階ロールアウト
- 横断的障害 → サービス分離、ロール/資格情報分離、バックアップ/復旧の演習

## 未決事項
- M2M 認証方式（HMAC 署名 / OAuth2 Client Credentials / 内部ネットワーク制限）
- チーム/委譲共有モデル（所有者以外に見せる条件）
