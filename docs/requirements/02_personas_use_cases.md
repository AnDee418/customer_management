# 02. ペルソナとユースケース（ドラフト）

## ペルソナ（例）
- 営業担当: 顧客状況の把握、直近の発注/測定の有無確認
- 受注管理担当: 発注IDの参照・照合、同期失敗の確認と再実行
- 技術/検査担当: 測定データIDから外部詳細へジャンプ、品質確認
- 管理者: 権限設定、監査ログ確認、設定値の変更

## 主要ユースケース（MVP 想定）
1. 顧客の登録/編集/検索/一覧/詳細閲覧
2. 顧客に紐づく発注データIDの参照（外部リンク付き）
3. 顧客に紐づく測定データIDの参照（外部リンク付き）
4. 外部連携の手動同期トリガ（発注/測定）
5. 同期失敗の原因確認と再試行
6. ロールベースのアクセス制御（閲覧/編集/同期の可否）
7. 監査ログの閲覧（主要操作: create/update/delete/sync/retry）

## ユーザーストーリー（例）
- 営業担当として、顧客詳細に最新の発注/測定IDが表示されることで、会話準備を短時間で完了したい。
- 受注管理担当として、同期失敗時に理由を把握し、再試行できることで、処理停滞を最小化したい。
- 技術/検査担当として、測定データIDから外部の詳細画面へワンクリックで遷移し、品質確認を迅速に行いたい。
- 管理者として、役割ごとの権限制御と監査ログで、内部統制に対応したい。

## 受け入れ基準（抜粋）
- 顧客詳細に、関連する外部IDがリスト表示され、クリックで外部システムへ遷移できる。
- 権限に応じて、閲覧・編集・同期再試行の可否が適切に制御される。
- 監査ログに主要操作（作成/更新/削除/同期/再試行）が記録され、検索できる。

## 業務フロー（概略）
- 顧客作成 → 外部ID連携（非同期） → 顧客詳細での参照。
- 外部→内製: Webhook/ポーリングにより更新受信 → 差分マージ → 顧客詳細反映。
- 失敗時: integration_jobs に失敗記録 → UI で再試行 → 結果を監査ログへ保存。

## 画面（MVP）
- 顧客一覧/検索
- 顧客詳細（発注ID・測定IDタブ/セクション表示、外部リンク）
- 顧客作成/編集
- 連携ジョブ一覧/詳細（失敗理由、再試行ボタン）
- 監査ログ一覧
- 設定/権限（簡易）

## 権限（抜粋・方針）
- 管理者: すべての閲覧/編集/同期/監査ログ閲覧が可能。
- 一般ユーザー: 顧客閲覧、紐づく外部ID閲覧が可能。編集/同期はロールで制御。
- 監査ログは管理者のみ閲覧可。

## 追加ユースケース（PM補足）
8. 所有権移譲（退職/異動時に顧客の owner_user_id を安全に委譲）
9. 障害時運用（Webhook 不達/遅延時の補助Pull実行、再試行、影響範囲確認）
10. 権限変更の監査（ロール変更・チーム移動の履歴参照）

## 受け入れ基準（追加）
- 所有権移譲は監査ログに記録され、RLS が即時反映される
- 障害時の補助Pullは期間/顧客フィルタ指定ができ、二重取り込みを防ぐ
- 権限変更履歴は管理者が検索/抽出できる
